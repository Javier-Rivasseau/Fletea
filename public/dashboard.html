<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fletea - Dashboard</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f0f2f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        h1,
        h2 {
            color: #333;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #2ecc71;
        }

        .list-item {
            border-bottom: 1px solid #eee;
            padding: 10px 0;
        }

        .tag {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
        }

        .tag-camionero {
            background: #e3f2fd;
            color: #1976d2;
        }

        .tag-productor {
            background: #e8f5e9;
            color: #388e3c;
        }

        .tag-match {
            background: #fff3e0;
            color: #f57c00;
            font-weight: bold;
        }

        #logs {
            font-family: monospace;
            background: #333;
            color: #0f0;
            padding: 10px;
            height: 200px;
            overflow-y: scroll;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h1>üöõ Fletea Dashboard</h1>
            <div id="health-badge"
                style="padding: 5px 10px; border-radius: 20px; font-size: 0.8em; background: #95a5a6; color: white;">
                Cargando estado...</div>
        </div>

        <div class="card" style="margin-bottom: 20px;">
            <h2>Estad√≠sticas en Vivo</h2>
            <div class="grid" id="stats">
                <div>Usuarios: <span id="stat-users" class="stat-value">0</span></div>
                <div>Viajes Activos: <span id="stat-trips" class="stat-value">0</span></div>
                <div>Matches: <span id="stat-matches" class="stat-value">0</span></div>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <h2>√öltimos Matches</h2>
                <div id="matches-list">Cargando...</div>
            </div>
            <div class="card">
                <h2>üîç Historial de Chat</h2>
                <p style="font-size: 0.8em; color: #666;">Ingres√° un n√∫mero de celular para ver sus mensajes.</p>
                <input type="text" id="phone-filter" placeholder="Celular (ej. 54911...)"
                    style="width: 100%; padding: 8px; margin-bottom: 10px; box-sizing: border-box;">
                <button id="btn-load-chat" onclick="loadChat()" style="width: 100%; padding: 10px; cursor: pointer;">Ver
                    Historial</button>
                <div id="chat-history"
                    style="margin-top: 10px; max-height: 250px; overflow-y: auto; border-top: 1px solid #eee;"></div>
            </div>

            <div class="card" style="border: 2px solid #2ecc71;">
                <h2>üéÆ Simulador de Bot</h2>
                <p style="font-size: 0.8em; color: #666;">Chate√° ac√° para probar al bot <b>sin WhatsApp</b>.</p>
                <div id="sim-chat"
                    style="height: 200px; overflow-y: scroll; border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; background: #f9f9f9; border-radius: 4px;">
                </div>
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="sim-input" placeholder="Escrib√≠ 'hola'..." style="flex: 1; padding: 8px;"
                        onkeypress="if(event.key==='Enter') sendSimMessage()">
                    <button id="btn-send-sim" onclick="sendSimMessage()"
                        style="padding: 8px 16px; background: #2ecc71; color: white; border: none; cursor: pointer; border-radius: 4px;">Enviar</button>
                </div>
            </div>

            <div class="card">
                <h2>Usuarios Registrados</h2>
                <div id="users-list" style="max-height: 300px; overflow-y: auto;">Cargando...</div>
            </div>
        </div>
    </div>

    <script>
        async function fetchAPI(endpoint) {
            try {
                const res = await fetch(`/api${endpoint}`);
                if (!res.ok) throw new Error(`Error ${res.status}`);
                return await res.json();
            } catch (e) {
                console.error(e);
                return null;
            }
        }

        async function updateHealth() {
            const health = await fetchAPI('/health');
            const badge = document.getElementById('health-badge');
            console.log('Health Status Check:', health);
            if (health) {
                const dbStatus = health.database === 'connected' ? 'üü¢ DB' : 'üî¥ DB Offline';
                const aiStatus = health.ai === 'online' ? 'ü§ñ AI' : 'üë§ Sim AI';
                badge.innerHTML = `${dbStatus} | ${aiStatus}`;
                badge.style.background = health.database === 'connected' ? '#2ecc71' : '#e74c3c';
            } else {
                badge.innerHTML = '‚ö†Ô∏è Error API';
                badge.style.background = '#e67e22';
            }
        }

        async function updateDashboard() {
            updateHealth();
            // Stats
            const stats = await fetchAPI('/stats');
            if (stats) {
                document.getElementById('stat-users').innerText = stats.totalUsers || 0;
                document.getElementById('stat-trips').innerText = stats.activeTrips || 0;
                document.getElementById('stat-matches').innerText = stats.matchesRealizados || 0;
            }

            // Matches
            const matches = await fetchAPI('/matches');
            const matchesList = document.getElementById('matches-list');
            matchesList.innerHTML = '';
            if (matches && matches.length > 0) {
                matches.forEach(m => {
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    div.innerHTML = `
                        <span class="tag tag-match">${m.status.toUpperCase()}</span><br>
                        üöõ <b>${m.camionero_name}</b> (${m.camionero_locality})<br>
                        üåæ <b>${m.productor_name}</b> (${m.productor_locality})<br>
                        Score: ${Math.round(m.score)}%
                    `;
                    matchesList.appendChild(div);
                });
            } else {
                matchesList.innerHTML = 'No hay matches activos.';
            }

            // Users
            const users = await fetchAPI('/users');
            const usersList = document.getElementById('users-list');
            usersList.innerHTML = '';
            if (users && users.length > 0) {
                users.forEach(u => {
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    const tagClass = u.type === 'camionero' ? 'tag-camionero' : 'tag-productor';
                    div.innerHTML = `
                        <span class="tag ${tagClass}">${u.type}</span> <b>${u.name || 'Sin Nombre'}</b><br>
                        üì± ${u.phone} <br>
                        üìç ${u.locality || '-'}
                    `;
                    usersList.appendChild(div);
                });
            } else {
                usersList.innerHTML = 'No hay usuarios registrados.';
            }
        }

        async function loadChat() {
            const phone = document.getElementById('phone-filter').value;
            if (!phone) return;
            const history = await fetchAPI(`/conversations/${phone}`);
            const chatDiv = document.getElementById('chat-history');
            chatDiv.innerHTML = '';
            if (history && history.length > 0) {
                history.forEach(msg => {
                    const div = document.createElement('div');
                    div.style.marginBottom = '8px';
                    div.style.padding = '5px';
                    div.style.borderRadius = '4px';
                    div.style.background = msg.role === 'user' ? '#fff' : '#e3f2fd';
                    div.innerHTML = `<b>${msg.role}:</b> ${msg.content}`;
                    chatDiv.appendChild(div);
                });
            } else {
                chatDiv.innerHTML = 'Sin historial.';
            }
        }

        async function sendSimMessage() {
            const input = document.getElementById('sim-input');
            const chat = document.getElementById('sim-chat');
            const text = input.value.trim();
            if (!text) return;

            // User msg
            chat.innerHTML += `<div style="text-align: right; margin: 5px; color: #333;"><b>Vos:</b> ${text}</div>`;
            const loadingDiv = document.createElement('div');
            loadingDiv.style.color = '#999';
            loadingDiv.innerHTML = '<i>Escribiendo...</i>';
            chat.appendChild(loadingDiv);

            input.value = '';
            chat.scrollTop = chat.scrollHeight;

            try {
                const res = await fetch('/api/simulate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone: 'web-user', name: 'Tester Web', text })
                });
                const data = await res.json();

                loadingDiv.remove();
                // Bot msg
                chat.innerHTML += `<div style="text-align: left; margin: 5px; color: #2980b9;"><b>Bot:</b> ${data.response || '...'}</div>`;
                if (data.action) {
                    chat.innerHTML += `<div style="background: #eee; font-size: 0.8em; padding: 5px;">üîß Acci√≥n: ${data.action.action}</div>`;
                }
                chat.scrollTop = chat.scrollHeight;
                updateDashboard(); // Refresh stats
            } catch (e) {
                chat.innerHTML += `<div style="color: red;">Error: ${e.message}</div>`;
            }
        }

        // Auto-update stats every 5s
        updateDashboard();
        setInterval(updateDashboard, 5000);
    </script>
</body>

</html>